import argparse
import pandas as pd
import time
from sklearn.model_selection import cross_val_score
from sklearn.metrics import classification_report, confusion_matrix, accuracy_score

from Classifier.Classifier import Classifier, Feature

clf = Classifier()

def main():
    start = time.time()

    ## Get Command-line Arguments #################
    parser = argparse.ArgumentParser()
    parser.add_argument('-d', '--data', default='../../data', help='')
    opts = parser.parse_args()
    ###############################################

    dynamic_training_data_dict = LoadDataDynamic(opts.data, 'dynamic_train_data.csv')
    dynamic_testing_data_dict = LoadDataDynamic(opts.data, 'dynamic_test_data.csv')

    static_training_data_dict = LoadDataStatic(opts.data, 'static_train_data.csv')
    static_testing_data_dict = LoadDataStatic(opts.data, 'static_test_data.csv')

    dynamic_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.EMBEDDED_DOMAINS_LIST, Feature.IMPORTS_LIST, Feature.CONTACTED_URLS_LIST,
                        Feature.SIGNATURES, Feature.BEHAVIOR_CALLS, Feature.BEHAVIOR_DLL_LOADED, Feature.NETWORK_HTTP, Feature.NETWORK_HOSTS, Feature.STRINGS
                        ]
    #dynamic_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.EMBEDDED_DOMAINS_LIST, Feature.IMPORTS_LIST]
    #dynamic_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.SIGNATURES, Feature.BEHAVIOR_CALLS, Feature.BEHAVIOR_DLL_LOADED, Feature.NETWORK_HTTP, Feature.NETWORK_HOSTS, Feature.STRINGS]
    #dynamic_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.EMBEDDED_DOMAINS_LIST]
    # DYNAMIC
    print('## Dynamic Testing ##')
    nb_clf = clf.BuildClassifierNB(dynamic_training_data_dict, dynamic_training_data_dict['classification'], 
        dynamic_features,
    )
    nb_predictions = nb_clf.predict(dynamic_testing_data_dict)
    print("NB Accuracy: %0.3f" % (accuracy_score(dynamic_testing_data_dict['classification'], nb_predictions)))

    svm_clf = clf.BuildClassifierSVM(dynamic_training_data_dict, dynamic_training_data_dict['classification'], 
        dynamic_features,
    )
    svm_predictions = svm_clf.predict(dynamic_testing_data_dict)
    print("SVM Accuracy: %0.3f" % (accuracy_score(dynamic_testing_data_dict['classification'], svm_predictions)))

    print("")

    static_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.EMBEDDED_DOMAINS_LIST, Feature.IMPORTS_LIST, Feature.CONTACTED_URLS_LIST]
    #static_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.EMBEDDED_DOMAINS_LIST]
    #static_features = [Feature.TRID, Feature.PE_RESOURCE_LIST, Feature.EMBEDDED_DOMAINS_LIST, Feature.IMPORTS_LIST]
    # STATIC
    print('## Static Testing ##')
    nb_clf = clf.BuildClassifierNB(static_training_data_dict, static_training_data_dict['classification'], static_features)
    nb_predictions = nb_clf.predict(static_testing_data_dict)
    print("NB Accuracy: %0.3f" % (accuracy_score(static_testing_data_dict['classification'], nb_predictions)))

    svm_clf = clf.BuildClassifierSVM(static_training_data_dict, static_training_data_dict['classification'], static_features)
    svm_predictions = svm_clf.predict(static_testing_data_dict)
    print("SVM Accuracy: %0.3f" % (accuracy_score(static_testing_data_dict['classification'], svm_predictions)))

    end = time.time()
    print("Time Run = %fs" % (end - start))

def FeatureTesting():
    nb_clf = clf.BuildClassifierNB(training_data_dict, training_data_dict['classification'], [Feature.TRID, Feature.PE_RESOURCE_LIST])
    nb_predictions = nb_clf.predict(testing_data_dict)
    print("NB Accuracy: %0.3f" % (accuracy_score(testing_data_dict['classification'], nb_predictions)))

    #feats = nb_clf.named_steps['features']
    #X = feats.transform(training_data_dict)
    #Y = feats.transform(testing_data_dict)
    #print(X)
    #print(Y)

    return

def LoadDataStatic(data_folder_path, file_name):
    data_dict = {}
    data_dict['classification'] = []
    data_dict['embedded_domains_list'] = []
    data_dict['trid'] = []
    data_dict['pe_resource_list'] = []
    data_dict['imports_list'] = []
    data_dict['contacted_urls_list'] = []

    df = pd.read_csv(data_folder_path + '/' + file_name)
    for i in range(len(df['hash'])):
        embedded_domains_list = df['embedded_domains_list'][i]
        if embedded_domains_list != embedded_domains_list:
            embedded_domains_list = ''
        pe_resource_list = df['pe_resource_list'][i]
        if pe_resource_list != pe_resource_list:
            pe_resource_list = ''
        imports_list = df['imports_list'][i]
        if imports_list != imports_list:
            imports_list = ''
        contacted_urls_list = df['contacted_urls_list'][i]
        if contacted_urls_list != contacted_urls_list:
            contacted_urls_list = ''

        data_dict['classification'].append(df['classification'][i])
        data_dict['embedded_domains_list'].append(embedded_domains_list)
        data_dict['trid'].append(df['trid'][i])
        data_dict['pe_resource_list'].append(pe_resource_list)
        data_dict['imports_list'].append(imports_list)
        data_dict['contacted_urls_list'].append(contacted_urls_list)

    return data_dict

def LoadDataDynamic(data_folder_path, file_name):
    data_dict = {}
    data_dict['classification'] = []

    data_dict['signatures'] = []
    data_dict['behavior_calls'] = []
    data_dict['behavior_dll_loaded'] = []
    data_dict['network_udp_src'] = []
    data_dict['network_udp_dst'] = []
    data_dict['network_http'] = []
    data_dict['network_hosts'] = []
    data_dict['strings'] = []

    data_dict['embedded_domains_list'] = []
    data_dict['trid'] = []
    data_dict['pe_resource_list'] = []
    data_dict['imports_list'] = []
    data_dict['contacted_urls_list'] = []

    df = pd.read_csv(data_folder_path + '/' + file_name)
    for i in range(len(df['hash'])):
        signatures = df['signatures'][i]
        if signatures != signatures:
            signatures = ''
        behavior_calls = df['behavior_calls'][i]
        if behavior_calls != behavior_calls:
            behavior_calls = ''
        behavior_dll_loaded = df['behavior_dll_loaded'][i]
        if behavior_dll_loaded != behavior_dll_loaded:
            behavior_dll_loaded = ''
        network_udp_src = df['network_udp_src'][i]
        if network_udp_src != network_udp_src:
            network_udp_src = ''
        network_udp_dst = df['network_udp_dst'][i]
        if network_udp_dst != network_udp_dst:
            network_udp_dst = ''
        network_http = df['network_http'][i]
        if network_http != network_http:
            network_http = ''
        network_hosts = df['network_hosts'][i]
        if network_hosts != network_hosts:
            network_hosts = ''
        strings = df['strings'][i]
        if strings != strings:
            strings = ''

        embedded_domains_list = df['embedded_domains_list'][i]
        if embedded_domains_list != embedded_domains_list:
            embedded_domains_list = ''
        pe_resource_list = df['pe_resource_list'][i]
        if pe_resource_list != pe_resource_list:
            pe_resource_list = ''
        imports_list = df['imports_list'][i]
        if imports_list != imports_list:
            imports_list = ''
        contacted_urls_list = df['contacted_urls_list'][i]
        if contacted_urls_list != contacted_urls_list:
            contacted_urls_list = ''

        data_dict['classification'].append(df['classification'][i])

        data_dict['signatures'].append(signatures)
        data_dict['behavior_calls'].append(behavior_calls)
        data_dict['behavior_dll_loaded'].append(behavior_dll_loaded)
        data_dict['network_udp_src'].append(network_udp_src)
        data_dict['network_udp_dst'].append(network_udp_dst)
        data_dict['network_http'].append(network_http)
        data_dict['network_hosts'].append(network_http)
        data_dict['strings'].append(strings)

        data_dict['embedded_domains_list'].append(embedded_domains_list)
        data_dict['trid'].append(df['trid'][i])
        data_dict['pe_resource_list'].append(pe_resource_list)
        data_dict['imports_list'].append(imports_list)
        data_dict['contacted_urls_list'].append(contacted_urls_list)

    return data_dict

if __name__ == '__main__':
    main()