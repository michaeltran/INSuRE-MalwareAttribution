import requests
import sys
import os.path


class Downloader:
    def __init__(self, id, dir):
        self.URL = "https://docs.google.com/uc?export=download"
        self.id = id
        self.file_name = "default.zip"
        self.dir = dir
        self.destination = os.path.join(self.dir, self.file_name)

    def download_file_from_google_drive(self):
        session = requests.Session()
        response = session.get(self.URL, params={"id": self.id}, stream=True)
        token = self.get_confirm_token(response)

        if token:
            params = {"id": self.id, "confirm": token}
            response = session.get(self.URL, params=params, stream=True)

        self.file_name = self.get_file_name(response.headers.get("Content-Disposition"))
        self.destination = os.path.join(self.dir, self.file_name)
        self.save_response_content(response)

    def get_confirm_token(self, response):
        for key, value in response.cookies.items():
            if key.startswith("download_warning"):
                return value

        return None

    def save_response_content(self, response):
        CHUNK_SIZE = 32768
        print("Downloading: ", self.file_name)
        with open(self.destination, "wb") as f:
            for chunk in response.iter_content(CHUNK_SIZE):
                if chunk:  # filter out keep-alive new chunks
                    f.write(chunk)

    def get_file_name(self, content_headers):
        return content_headers.split("=")[1].split(";")[0].strip('"')
